<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Felajánlások Adatmegjelenítő 2023-2025</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

  <style>
    .stats-card { border-left: 4px solid #0d6efd; }
    .adoszam-display { font-family: monospace; font-weight: bold; }
    .table-container { box-shadow: 0 0 20px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
    .nav-pills .nav-link.active { background-color: #0d6efd; }
    .year-badge { font-size: 0.8em; margin-left: 8px; }
  </style>
</head>
<body>
<div class="container-fluid py-4">
  <h1 class="mb-4"><i class="bi bi-bar-chart me-2"></i>Felajánlások 2023–2025</h1>

  <!-- Tabs -->
  <ul class="nav nav-pills mb-3" id="yearTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#combined">Összesítő</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#year2025">2025</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#year2024">2024</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#year2023">2023</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="combined">
      <div id="combinedStats" class="row mb-3"></div>
      <table id="combinedTable" class="table table-striped table-hover w-100"></table>
    </div>
    <div class="tab-pane fade" id="year2025"><div id="stats2025" class="row mb-3"></div><table id="table2025" class="table table-striped w-100"></table></div>
    <div class="tab-pane fade" id="year2024"><div id="stats2024" class="row mb-3"></div><table id="table2024" class="table table-striped w-100"></table></div>
    <div class="tab-pane fade" id="year2023"><div id="stats2023" class="row mb-3"></div><table id="table2023" class="table table-striped w-100"></table></div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
$(async function() {
  let datasets = {};
  let years = [2023, 2024, 2025];

  // JSON betöltése
  for (let y of years) {
    try {
      datasets[y] = await $.getJSON(`${y}.json`);
    } catch {
      datasets[y] = { adatok: [] };
    }
  }

  // Egy év feldolgozása
  function processYear(year) {
    let adatok = datasets[year].adatok || [];
    let totalO = _.sumBy(adatok, 'o');
    let totalF = _.sumBy(adatok, 'f');
    let statsHtml = `
      <div class="col"><div class="card"><div class="card-body">Cégek: ${adatok.length}</div></div></div>
      <div class="col"><div class="card"><div class="card-body">Összeg: ${totalO.toLocaleString('hu-HU')} Ft</div></div></div>
      <div class="col"><div class="card"><div class="card-body">Felajánlók: ${totalF.toLocaleString('hu-HU')}</div></div></div>
      <div class="col"><div class="card"><div class="card-body">Átlag/fő: ${(totalF>0?Math.round(totalO/totalF):0).toLocaleString('hu-HU')} Ft</div></div></div>`;
    $(`#stats${year}`).html(statsHtml);

    let tableData = adatok.map(d => [
      d.i, `<span class="adoszam-display">${d.a}</span>`, d.n, d.c,
      d.o.toLocaleString('hu-HU')+" Ft", d.f+" fő", d.f>0?Math.round(d.o/d.f).toLocaleString('hu-HU')+" Ft":"0 Ft"
    ]);
    $(`#table${year}`).DataTable({
      data: tableData,
      columns: [
        { title:"Sorszám" }, { title:"Adószám" }, { title:"Név" },
        { title:"Cím" }, { title:"Összeg" }, { title:"Fő" }, { title:"Átlag/fő" }
      ],
      pageLength: 25,
      language: { url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/hu.json" }
    });
  }

  years.forEach(processYear);

  // Combined
  let companies = {};
  years.forEach(y => {
    (datasets[y].adatok||[]).forEach(d => {
      if (!companies[d.a]) companies[d.a] = { nev:d.n, a:d.a, c:d.c, [2023]:{o:0,f:0}, [2024]:{o:0,f:0}, [2025]:{o:0,f:0} };
      companies[d.a][y].o += d.o;
      companies[d.a][y].f += d.f;
    });
  });

  let rows = Object.values(companies).map(c => {
    let to = c[2023].o + c[2024].o + c[2025].o;
    let tf = c[2023].f + c[2024].f + c[2025].f;
    return [
      c.nev, `<span class="adoszam-display">${c.a}</span>`,
      c[2023].o.toLocaleString('hu-HU')+" Ft", c[2023].f+" fő",
      c[2024].o.toLocaleString('hu-HU')+" Ft", c[2024].f+" fő",
      c[2025].o.toLocaleString('hu-HU')+" Ft", c[2025].f+" fő",
      to.toLocaleString('hu-HU')+" Ft", tf+" fő",
      tf>0?Math.round(to/tf).toLocaleString('hu-HU')+" Ft":"0 Ft"
    ];
  });

  let totalCompanies = rows.length;
  let totalO = _.sumBy(Object.values(companies), c => c[2023].o+c[2024].o+c[2025].o);
  let totalF = _.sumBy(Object.values(companies), c => c[2023].f+c[2024].f+c[2025].f);
  let avg = totalF>0?Math.round(totalO/totalF):0;
  $('#combinedStats').html(`
    <div class="col"><div class="card"><div class="card-body">Cégek: ${totalCompanies}</div></div></div>
    <div class="col"><div class="card"><div class="card-body">Összesen: ${totalO.toLocaleString('hu-HU')} Ft</div></div></div>
    <div class="col"><div class="card"><div class="card-body">Felajánlók: ${totalF}</div></div></div>
    <div class="col"><div class="card"><div class="card-body">Átlag/fő: ${avg.toLocaleString('hu-HU')} Ft</div></div></div>
  `);

  $('#combinedTable').DataTable({
    data: rows,
    columns: [
      { title:"Név" },{ title:"Adószám" },
      { title:"2023 összeg" },{ title:"2023 fő" },
      { title:"2024 összeg" },{ title:"2024 fő" },
      { title:"2025 összeg" },{ title:"2025 fő" },
      { title:"Összes összeg" },{ title:"Összes fő" },{ title:"Átlag/fő" }
    ],
    scrollX:true,
    pageLength:25,
    language:{ url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/hu.json" }
  });
});
</script>
</body>
</html>
