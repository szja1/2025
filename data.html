<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Felajánlások Dashboard 2023-2025</title>
    
    <!-- Modern CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    
    <style>
        :root {
            --primary-color: #a8dadc;
            --secondary-color: #457b9d;
            --accent-color: #1d3557;
            --light-color: #f1faee;
            --text-color: #264653;
            --border-color: #e9ecef;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        body {
            background: linear-gradient(135deg, #f1faee 0%, #e9ecef 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
        }

        .dashboard-container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .control-panel {
            background: var(--light-color);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .load-btn {
            background: var(--primary-color);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .load-btn:hover {
            background: var(--secondary-color);
            color: white;
        }

        .load-btn:disabled {
            background: #ced4da;
            color: #6c757d;
        }

        .stats-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            height: auto;
            margin-bottom: 0.75rem;
        }

        .stats-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .stats-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0.25rem 0;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .stats-icon {
            background: var(--primary-color);
            color: var(--text-color);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .nav-pills-custom {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 0.25rem;
        }

        .nav-pills-custom .nav-link {
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-color);
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 0 0.125rem;
            padding: 0.5rem 0.75rem;
            font-size: 13px;
        }

        .nav-pills-custom .nav-link.active {
            background: white;
            color: var(--accent-color);
            box-shadow: var(--shadow);
        }

        .table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .table th {
            background: var(--light-color);
            border: none;
            font-weight: 600;
            color: var(--text-color);
            padding: 0.75rem 0.5rem;
            font-size: 12px;
            white-space: nowrap;
        }

        .table td {
            border: none;
            padding: 0.5rem;
            vertical-align: middle;
            font-size: 13px;
        }

        .table tbody tr {
            border-bottom: 1px solid #f8f9fa;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .adoszam-display {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            background: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }

        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .preloader-content {
            text-align: center;
            color: var(--text-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar-custom {
            height: 4px;
            border-radius: 2px;
            background: var(--border-color);
            margin-top: 1rem;
            overflow: hidden;
            width: 200px;
            margin: 1rem auto 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .status-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-loaded { background: #28a745; }
        .status-loading { background: #ffc107; animation: pulse 1.5s infinite; }
        .status-error { background: #dc3545; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dt-buttons {
            margin-bottom: 0.75rem;
        }

        .dt-button {
            background: var(--primary-color) !important;
            border: none !important;
            color: var(--text-color) !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 12px !important;
            border-radius: 4px !important;
            margin-right: 0.25rem !important;
        }

        .dt-button:hover {
            background: var(--secondary-color) !important;
            color: white !important;
        }

        @media (min-width: 768px) {
            body {
                font-size: 15px;
            }
            
            .stats-value {
                font-size: 1.5rem;
            }
            
            .stats-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .table th {
                font-size: 13px;
            }
            
            .table td {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div id="preloader" class="preloader" style="display: none;">
        <div class="preloader-content">
            <div class="spinner"></div>
            <h6 id="preloaderText">Adatok betöltése...</h6>
            <div id="preloaderPercent" class="fw-bold fs-4 mb-2">0%</div>
            <div class="progress-bar-custom">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row align-items-center">
                <div class="col-12 col-md-8 mb-2 mb-md-0">
                    <div class="btn-group flex-wrap" role="group">
                        <button id="load2023" class="btn load-btn me-2 mb-2">
                            <span class="status-indicator" id="status2023"></span>
                            <i class="bi bi-download me-1"></i>2023
                        </button>
                        <button id="load2024" class="btn load-btn me-2 mb-2">
                            <span class="status-indicator" id="status2024"></span>
                            <i class="bi bi-download me-1"></i>2024
                        </button>
                        <button id="load2025" class="btn load-btn me-2 mb-2">
                            <span class="status-indicator" id="status2025"></span>
                            <i class="bi bi-download me-1"></i>2025
                        </button>
                        <button id="loadAll" class="btn btn-secondary me-2 mb-2">
                            <i class="bi bi-cloud-download me-1"></i>Összes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="p-3">
            <ul class="nav nav-pills nav-pills-custom" id="yearTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="combined-tab" data-bs-toggle="pill" data-bs-target="#combined" type="button">
                        <i class="bi bi-pie-chart me-1"></i>Összesítő
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="year2025-tab" data-bs-toggle="pill" data-bs-target="#year2025" type="button">
                        <i class="bi bi-calendar3 me-1"></i>2025
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="year2024-tab" data-bs-toggle="pill" data-bs-target="#year2024" type="button">
                        <i class="bi bi-calendar2 me-1"></i>2024
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="year2023-tab" data-bs-toggle="pill" data-bs-target="#year2023" type="button">
                        <i class="bi bi-calendar me-1"></i>2023
                    </button>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div class="tab-content px-3 pb-3">
            <!-- Combined View -->
            <div class="tab-pane fade show active" id="combined">
                <div id="combinedStats" class="row"></div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="combinedTable" class="table table-sm w-100">
                            <thead>
                                <tr>
                                    <th>Név</th>
                                    <th>2023 összeg</th>
                                    <th>2023 létszám</th>
                                    <th>2024 összeg</th>
                                    <th>2024 létszám</th>
                                    <th>2025 összeg</th>
                                    <th>2025 létszám</th>
                                    <th>Összes összeg</th>
                                    <th>Összes létszám</th>
                                    <th>Átlag/fő</th>
                                    <th>Éves jövedelem/fő</th>
                                    <th>Adószám</th>
                                    <th>Cím</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Individual Year Views -->
            <div class="tab-pane fade" id="year2025">
                <div id="stats2025" class="row"></div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="table2025" class="table table-sm w-100"></table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="year2024">
                <div id="stats2024" class="row"></div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="table2024" class="table table-sm w-100"></table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="year2023">
                <div id="stats2023" class="row"></div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="table2023" class="table table-sm w-100"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <script>
        class DashboardManager {
            constructor() {
                this.datasets = {};
                this.years = [2023, 2024, 2025];
                this.loadedYears = new Set();
                this.dataTables = {};
                this.loadPromises = {};
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateUI();
            }

            bindEvents() {
                this.years.forEach(year => {
                    $(`#load${year}`).on('click', () => this.loadYear(year));
                });
                $('#loadAll').on('click', () => this.loadAllYears());
            }

            async loadYear(year, showPreloader = true) {
                if (this.loadPromises[year]) {
                    return this.loadPromises[year];
                }

                if (showPreloader) {
                    this.showPreloader(`${year} adatok betöltése...`);
                }

                this.updateStatus(year, 'loading');
                $(`#load${year}`).prop('disabled', true);

                this.loadPromises[year] = this.fetchYearData(year);

                try {
                    const data = await this.loadPromises[year];
                    this.datasets[year] = data;
                    this.loadedYears.add(year);
                    
                    this.updateStatus(year, 'loaded');
                    this.processYearData(year);
                    this.updateCombinedData();
                    this.updateUI();
                    
                    if (showPreloader) {
                        setTimeout(() => this.hidePreloader(), 200);
                    }
                    
                } catch (error) {
                    console.error(`Hiba ${year} betöltésekor:`, error);
                    this.updateStatus(year, 'error');
                    if (showPreloader) {
                        this.hidePreloader();
                    }
                    this.showAlert(`Hiba: ${year} adatok betöltése sikertelen!`);
                } finally {
                    $(`#load${year}`).prop('disabled', false);
                    delete this.loadPromises[year];
                }
            }

            async fetchYearData(year) {
                const response = await fetch(`${year}.json`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const total = parseInt(response.headers.get('content-length')) || 0;
                let loaded = 0;
                
                const reader = response.body.getReader();
                const stream = new ReadableStream({
                    start(controller) {
                        function pump() {
                            return reader.read().then(({ done, value }) => {
                                if (done) {
                                    controller.close();
                                    return;
                                }
                                loaded += value.byteLength;
                                const progress = total ? Math.round((loaded / total) * 100) : 0;
                                this.updateProgress(progress);
                                controller.enqueue(value);
                                return pump();
                            });
                        }
                        return pump.call(this);
                    }.bind(this)
                });
                
                const newResponse = new Response(stream);
                return await newResponse.json();
            }

            async loadAllYears() {
                this.showPreloader('Összes adat betöltése...');
                
                const promises = this.years.map(year => this.loadYear(year, false));
                
                try {
                    await Promise.all(promises);
                    setTimeout(() => this.hidePreloader(), 200);
                } catch (error) {
                    this.hidePreloader();
                }
            }

            updateStatus(year, status) {
                const statusEl = $(`#status${year}`);
                statusEl.removeClass('status-loaded status-loading status-error');
                statusEl.addClass(`status-${status}`);
            }

            showPreloader(text) {
                $('#preloaderText').text(text);
                $('#preloaderPercent').text('0%');
                $('#progressFill').css('width', '0%');
                $('#preloader').show();
            }

            updateProgress(percent) {
                $('#preloaderPercent').text(`${percent}%`);
                $('#progressFill').css('width', `${percent}%`);
            }

            hidePreloader() {
                $('#preloader').hide();
            }

            processYearData(year) {
                const data = this.datasets[year];
                if (!data || !data.adatok) return;

                const adatok = data.adatok;
                const totalO = _.sumBy(adatok, 'o');
                const totalF = _.sumBy(adatok, 'f');
                const avgPerPerson = totalF > 0 ? Math.round(totalO / totalF) : 0;

                const statsHtml = `
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="stats-label">Cégek száma</div>
                            <div class="stats-value">${adatok.length.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <div class="stats-label">Összes felajánlás</div>
                            <div class="stats-value">${totalO.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="stats-label">Felajánlók száma</div>
                            <div class="stats-value">${totalF.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-calculator"></i>
                            </div>
                            <div class="stats-label">Átlag/fő</div>
                            <div class="stats-value">${avgPerPerson.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                `;

                $(`#stats${year}`).html(statsHtml);

                const tableData = adatok.map(d => {
                    const avgPerPerson = d.f > 0 ? Math.round(d.o / d.f) : 0;
                    const yearlyIncome = d.f > 0 ? Math.round((d.o / d.f) * 100 / 0.15) : 0;
                    
                    return [
                        d.i || '',
                        d.n || '',
                        d.o.toLocaleString('hu-HU'),
                        d.f.toLocaleString('hu-HU'),
                        avgPerPerson.toLocaleString('hu-HU'),
                        yearlyIncome.toLocaleString('hu-HU'),
                        `<span class="adoszam-display">${d.a}</span>`,
                        d.c || ''
                    ];
                });

                if (this.dataTables[year]) {
                    this.dataTables[year].destroy();
                }

                this.dataTables[year] = $(`#table${year}`).DataTable({
                    data: tableData,
                    columns: [
                        { title: "Sorszám" },
                        { title: "Név" },
                        { title: "Összeg" },
                        { title: "Létszám" },
                        { title: "Átlag/fő" },
                        { title: "Éves jövedelem/fő" },
                        { title: "Adószám" },
                        { title: "Cím" }
                    ],
                    pageLength: 25,
                    responsive: true,
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'csv',
                            text: 'CSV'
                        },
                        {
                            extend: 'excel', 
                            text: 'Excel'
                        },
                        {
                            extend: 'copy',
                            text: 'JSON',
                            action: function(e, dt, button, config) {
                                const data = dt.data().toArray();
                                navigator.clipboard.writeText(JSON.stringify(data, null, 2));
                                alert('JSON adatok vágólapra másolva!');
                            }
                        }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/hu.json"
                    },
                    order: [[2, 'desc']]
                });
            }

            updateCombinedData() {
                if (this.loadedYears.size === 0) return;

                const companies = {};
                
                this.years.forEach(year => {
                    if (!this.datasets[year] || !this.datasets[year].adatok) return;
                    
                    this.datasets[year].adatok.forEach(d => {
                        if (!companies[d.a]) {
                            companies[d.a] = {
                                nev: d.n,
                                adoszam: d.a,
                                cim: d.c,
                                2023: { o: 0, f: 0 },
                                2024: { o: 0, f: 0 },
                                2025: { o: 0, f: 0 }
                            };
                        }
                        companies[d.a][year].o += d.o;
                        companies[d.a][year].f += d.f;
                    });
                });

                const rows = Object.values(companies).map(c => {
                    const totalO = c[2023].o + c[2024].o + c[2025].o;
                    const totalF = c[2023].f + c[2024].f + c[2025].f;
                    const avgPerPerson = totalF > 0 ? Math.round(totalO / totalF) : 0;
                    const yearlyIncomePerPerson = totalF > 0 ? Math.round((totalO / totalF) * 100 / 0.15) : 0;

                    return [
                        c.nev,
                        c[2023].o.toLocaleString('hu-HU'),
                        c[2023].f.toLocaleString('hu-HU'),
                        c[2024].o.toLocaleString('hu-HU'),
                        c[2024].f.toLocaleString('hu-HU'),
                        c[2025].o.toLocaleString('hu-HU'),
                        c[2025].f.toLocaleString('hu-HU'),
                        totalO.toLocaleString('hu-HU'),
                        totalF.toLocaleString('hu-HU'),
                        avgPerPerson.toLocaleString('hu-HU'),
                        yearlyIncomePerPerson.toLocaleString('hu-HU'),
                        `<span class="adoszam-display">${c.adoszam}</span>`,
                        c.cim
                    ];
                });

                const totalCompanies = rows.length;
                const totalO = _.sumBy(Object.values(companies), c => c[2023].o + c[2024].o + c[2025].o);
                const totalF = _.sumBy(Object.values(companies), c => c[2023].f + c[2024].f + c[2025].f);
                const avgPerPerson = totalF > 0 ? Math.round(totalO / totalF) : 0;

                const combinedStatsHtml = `
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="stats-label">Összes cég</div>
                            <div class="stats-value">${totalCompanies.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <div class="stats-label">Összes felajánlás</div>
                            <div class="stats-value">${totalO.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="stats-label">Összes felajánló</div>
                            <div class="stats-value">${totalF.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="bi bi-calculator"></i>
                            </div>
                            <div class="stats-label">Átlag/fő</div>
                            <div class="stats-value">${avgPerPerson.toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                `;

                $('#combinedStats').html(combinedStatsHtml);

                if (this.dataTables.combined) {
                    this.dataTables.combined.destroy();
                }

                this.dataTables.combined = $('#combinedTable').DataTable({
                    data: rows,
                    pageLength: 25,
                    responsive: true,
                    scrollX: true,
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'csv',
                            text: 'CSV'
                        },
                        {
                            extend: 'excel',
                            text: 'Excel'
                        },
                        {
                            extend: 'copy',
                            text: 'JSON',
                            action: function(e, dt, button, config) {
                                const data = dt.data().toArray();
                                navigator.clipboard.writeText(JSON.stringify(data, null, 2));
                                alert('JSON adatok vágólapra másolva!');
                            }
                        }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/hu.json"
                    },
                    order: [[7, 'desc']] // Sort by total amount descending
                });
            }

            updateUI() {
                if (this.loadedYears.size === this.years.length) {
                    $('#loadAll').html('<i class="bi bi-check-circle me-1"></i>Betöltve')
                        .removeClass('btn-secondary').addClass('btn-success');
                }
            }

            showAlert(message) {
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show position-fixed" 
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 280px;" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                $('body').append(alertHtml);
                
                setTimeout(() => {
                    $('.alert').fadeOut(300, function() { $(this).remove(); });
                }, 4000);
            }

            // Utility methods
            getProcessedData(year) {
                return this.datasets[year];
            }

            getAllData() {
                return {
                    datasets: this.datasets,
                    loadedYears: Array.from(this.loadedYears)
                };
            }

            exportAllData() {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    loadedYears: Array.from(this.loadedYears),
                    data: this.datasets
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `felajanlasok_teljes_export_${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Initialize dashboard when DOM is ready
        $(document).ready(function() {
            window.dashboard = new DashboardManager();
            
            // Add keyboard shortcuts for power users
            $(document).keydown(function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.which) {
                        case 49: // Ctrl+1 - Load 2023
                            e.preventDefault();
                            $('#load2023').click();
                            break;
                        case 50: // Ctrl+2 - Load 2024
                            e.preventDefault();
                            $('#load2024').click();
                            break;
                        case 51: // Ctrl+3 - Load 2025
                            e.preventDefault();
                            $('#load2025').click();
                            break;
                        case 65: // Ctrl+A - Load All
                            e.preventDefault();
                            $('#loadAll').click();
                            break;
                        case 69: // Ctrl+E - Export All
                            e.preventDefault();
                            if (window.dashboard.loadedYears.size > 0) {
                                window.dashboard.exportAllData();
                            }
                            break;
                    }
                }
            });

            // Add touch gestures for mobile
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    const tabs = ['combined', 'year2025', 'year2024', 'year2023'];
                    const activeTab = $('.nav-link.active').attr('data-bs-target').replace('#', '');
                    const currentIndex = tabs.indexOf(activeTab);
                    
                    let newIndex;
                    if (diff > 0) { // Swipe left - next tab
                        newIndex = (currentIndex + 1) % tabs.length;
                    } else { // Swipe right - previous tab
                        newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                    }
                    
                    $(`button[data-bs-target="#${tabs[newIndex]}"]`).tab('show');
                }
            }

            // Add loading animation to buttons
            $('.load-btn').on('click', function() {
                const $btn = $(this);
                const originalHtml = $btn.html();
                $btn.html('<i class="bi bi-hourglass-split me-1"></i>Betöltés...');
                
                // Reset button after a short delay if not disabled by the actual loading
                setTimeout(() => {
                    if (!$btn.prop('disabled')) {
                        $btn.html(originalHtml);
                    }
                }, 500);
            });

            // Auto-hide alerts on scroll (mobile UX)
            let scrollTimeout;
            $(window).on('scroll', function() {
                $('.alert').addClass('opacity-50');
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    $('.alert').removeClass('opacity-50');
                }, 1000);
            });

            // Performance monitoring
            if ('performance' in window && 'measure' in window.performance) {
                window.performance.mark('dashboard-init-start');
                
                $(window).on('load', function() {
                    window.performance.mark('dashboard-init-end');
                    window.performance.measure('dashboard-init', 'dashboard-init-start', 'dashboard-init-end');
                    
                    const measure = window.performance.getEntriesByName('dashboard-init')[0];
                    console.log(`Dashboard initialization took ${Math.round(measure.duration)}ms`);
                });
            }
        });

        // Utility functions for external use
        window.dashboardUtils = {
            formatHungarianNumber: (number) => {
                return new Intl.NumberFormat('hu-HU').format(number);
            },
            
            formatHungarianCurrency: (amount) => {
                return new Intl.NumberFormat('hu-HU', {
                    style: 'currency',
                    currency: 'HUF',
                    minimumFractionDigits: 0
                }).format(amount);
            },
            
            calculateYearlyIncome: (amount, people) => {
                if (people === 0) return 0;
                return Math.round((amount / people) * 100 / 0.15);
            },
            
            calculatePercentageChange: (oldValue, newValue) => {
                if (oldValue === 0) return newValue > 0 ? 100 : 0;
                return Math.round(((newValue - oldValue) / oldValue) * 100);
            },
            
            generateCSV: (data, filename = 'export.csv') => {
                const csvContent = data.map(row => 
                    row.map(field => `"${field}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Add service worker for offline functionality (optional)
        if ('serviceWorker' in navigator && 'register' in navigator.serviceWorker) {
            window.addEventListener('load', () => {
                // Service worker registration would go here for offline support
                console.log('Dashboard ready for offline enhancements');
            });
        }
    </script>
</body>
</html>
