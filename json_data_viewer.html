<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Felajánlások Adatmegjelenítő</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    
    <style>
        .stats-card {
            border-left: 4px solid #0d6efd;
        }
        .file-drop-zone {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-drop-zone:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .file-drop-zone.dragover {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        .table-container {
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .adoszam-display {
            font-family: monospace;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-spreadsheet text-primary me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h1 class="mb-0">2025 Felajánlások Adatmegjelenítő</h1>
                        <p class="text-muted mb-0">JSON adatok interaktív megtekintése és elemzése</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="file-drop-zone" id="dropZone">
                            <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 3rem;"></i>
                            <h4>JSON fájl feltöltése</h4>
                            <p class="text-muted">Húzza ide a JSON fájlt vagy kattintson a böngészéshez</p>
                            <input type="file" class="d-none" id="fileInput" accept=".json">
                            <button class="btn btn-primary" id="browseBtn">
                                <i class="bi bi-folder-open me-2"></i>Böngészés
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4" id="statsSection" style="display: none;">
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-building text-primary me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="card-title mb-0">Cégek száma</h5>
                                <h3 class="mb-0" id="totalCompanies">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cash-coin text-success me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="card-title mb-0">Összes felajánlás</h5>
                                <h3 class="mb-0" id="totalAmount">0 Ft</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people text-info me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="card-title mb-0">Összes felajánló</h5>
                                <h3 class="mb-0" id="totalDonors">0 fő</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-calculator text-warning me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="card-title mb-0">Átlagos felajánlás</h5>
                                <h3 class="mb-0" id="avgAmount">0 Ft</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Info -->
        <div class="row mb-4" id="exportInfo" style="display: none;">
            <div class="col-12">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Export információ:</strong>
                            <span id="exportDetails"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row" id="tableSection" style="display: none;">
            <div class="col-12">
                <div class="card table-container">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-table me-2"></i>Felajánlások részletes listája
                            </h5>
                            <button class="btn btn-light btn-sm" id="exportBtn">
                                <i class="bi bi-download me-2"></i>Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table id="dataTable" class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Sorszám</th>
                                    <th>Adószám</th>
                                    <th>Cégnév</th>
                                    <th>Székhely</th>
                                    <th>Felajánlott összeg</th>
                                    <th>Felajánlók száma</th>
                                    <th>Átlagos felajánlás</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Betöltés...</span>
                    </div>
                    <h5>Adatok feldolgozása...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Hiba
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bezárás</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Lodash -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/hu.min.js"></script>

    <script>
        $(document).ready(function() {
            // Moment.js magyar lokalizáció
            moment.locale('hu');
            
            let jsonData = null;
            let dataTable = null;

            // Automatikus JSON fájl betöltése
            loadJSONFromPath();

            // File input és drop zone események
            $('#browseBtn').on('click', function() {
                $('#fileInput').click();
            });

            $('#dropZone').on('click', function() {
                $('#fileInput').click();
            });

            $('#fileInput').on('change', function(e) {
                handleFile(e.target.files[0]);
            });

            // Drag and drop események
            $('#dropZone').on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            $('#dropZone').on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
            });

            $('#dropZone').on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                const file = e.originalEvent.dataTransfer.files[0];
                handleFile(file);
            });

            // Automatikus JSON fájl betöltése
            function loadJSONFromPath() {
                const possiblePaths = [
                    'data.json',
                    '2025_adatok.json',
                    './data.json',
                    './2025_adatok.json'
                ];

                let loadedSuccessfully = false;

                // Próbáljuk betölteni az első elérhető JSON fájlt
                function tryLoadNext(index) {
                    if (index >= possiblePaths.length) {
                        // Ha egyik fájl sem elérhető, marad a feltöltési opció
                        updateDropZoneForManualUpload();
                        return;
                    }

                    const path = possiblePaths[index];
                    
                    $.ajax({
                        url: path,
                        type: 'GET',
                        dataType: 'json',
                        timeout: 5000,
                        success: function(data) {
                            if (!loadedSuccessfully) {
                                loadedSuccessfully = true;
                                jsonData = data;
                                processData(data);
                                updateDropZoneForSuccess(path);
                            }
                        },
                        error: function() {
                            // Próbáljuk a következő fájlt
                            tryLoadNext(index + 1);
                        }
                    });
                }

                // Indítjuk a betöltést
                updateDropZoneForLoading();
                tryLoadNext(0);
            }

            // Drop zone állapotok
            function updateDropZoneForLoading() {
                $('#dropZone').html(`
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Betöltés...</span>
                    </div>
                    <h4>JSON fájl automatikus betöltése...</h4>
                    <p class="text-muted">Keresés: data.json, 2025_adatok.json</p>
                `);
            }

            function updateDropZoneForSuccess(loadedFile) {
                $('#dropZone').removeClass('file-drop-zone').addClass('alert alert-success');
                $('#dropZone').html(`
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="bi bi-check-circle-fill me-3" style="font-size: 2rem;"></i>
                        <div class="text-start">
                            <h5 class="mb-0">Fájl sikeresen betöltve!</h5>
                            <p class="mb-0">Forrás: <strong>${loadedFile}</strong></p>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-outline-primary btn-sm" id="reloadBtn">
                            <i class="bi bi-arrow-clockwise me-2"></i>Újrabetöltés
                        </button>
                        <button class="btn btn-outline-secondary btn-sm ms-2" id="manualUploadBtn">
                            <i class="bi bi-cloud-upload me-2"></i>Új fájl feltöltése
                        </button>
                    </div>
                `);

                // Újrabetöltés gomb
                $('#reloadBtn').on('click', function() {
                    location.reload();
                });

                // Kézi feltöltés gomb
                $('#manualUploadBtn').on('click', function() {
                    $('#fileInput').click();
                });
            }

            function updateDropZoneForManualUpload() {
                $('#dropZone').html(`
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Nem található automatikusan betölthető JSON fájl
                    </div>
                    <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 3rem;"></i>
                    <h4>JSON fájl feltöltése</h4>
                    <p class="text-muted">Húzza ide a JSON fájlt vagy kattintson a böngészéshez</p>
                    <button class="btn btn-primary" id="browseBtn2">
                        <i class="bi bi-folder-open me-2"></i>Böngészés
                    </button>
                    <hr>
                    <small class="text-muted">
                        Automatikus betöltéshez helyezze a JSON fájlt a HTML mellé <strong>data.json</strong> vagy <strong>2025_adatok.json</strong> néven
                    </small>
                `);

                // Új böngészés gomb esemény
                $('#browseBtn2').on('click', function() {
                    $('#fileInput').click();
                });
            }

            // Export gomb esemény
            $('#exportBtn').on('click', function() {
                exportToCSV();
            });

            // Fájl kezelése (kézi feltöltés esetén)
            function handleFile(file) {
                if (!file) return;
                
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    showError('Kérjük, csak JSON fájlt töltsön fel!');
                    return;
                }

                $('#loadingModal').modal('show');

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        jsonData = JSON.parse(e.target.result);
                        processData(jsonData);
                        $('#loadingModal').modal('hide');
                        updateDropZoneForSuccess(file.name);
                    } catch (error) {
                        $('#loadingModal').modal('hide');
                        showError('Hibás JSON fájl formátum: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            // Adatok feldolgozása
            function processData(data) {
                try {
                    // Validálás
                    if (!data.adatok || !Array.isArray(data.adatok)) {
                        throw new Error('Hiányzó vagy hibás adatok struktúra');
                    }

                    // Export információk megjelenítése
                    displayExportInfo(data);

                    // Statisztikák számítása és megjelenítése
                    calculateAndDisplayStats(data.adatok);

                    // Táblázat inicializálása
                    initializeTable(data.adatok);

                    // Szekciók megjelenítése
                    $('#statsSection, #exportInfo, #tableSection').show();

                } catch (error) {
                    showError('Adatok feldolgozása sikertelen: ' + error.message);
                }
            }

            // Export információk megjelenítése
            function displayExportInfo(data) {
                const exportDate = moment(data.exportDatum).format('YYYY. MMMM DD. HH:mm:ss');
                const details = `
                    <strong>Dátum:</strong> ${exportDate} | 
                    <strong>Forrás:</strong> ${data.forrás} | 
                    <strong>Rekordok:</strong> ${data.rekordokSzáma} db
                `;
                $('#exportDetails').html(details);
            }

            // Statisztikák számítása
            function calculateAndDisplayStats(adatok) {
                const totalCompanies = adatok.length;
                const totalAmount = _.sumBy(adatok, 'felajanlottOsszeg');
                const totalDonors = _.sumBy(adatok, 'felajanlokSzama');
                const avgAmount = totalDonors > 0 ? Math.round(totalAmount / totalDonors) : 0;

                $('#totalCompanies').text(totalCompanies.toLocaleString('hu-HU'));
                $('#totalAmount').text(totalAmount.toLocaleString('hu-HU') + ' Ft');
                $('#totalDonors').text(totalDonors.toLocaleString('hu-HU') + ' fő');
                $('#avgAmount').text(avgAmount.toLocaleString('hu-HU') + ' Ft');
            }

            // Táblázat inicializálása
            function initializeTable(adatok) {
                // Ha már létezik táblázat, akkor töröljük
                if (dataTable) {
                    dataTable.destroy();
                    $('#dataTable tbody').empty();
                }

                // Adatok előkészítése
                const tableData = adatok.map(item => {
                    const adoszam = `${item.adoszam.resz1}-${item.adoszam.resz2}-${item.adoszam.resz3}`;
                    const avgPerDonor = item.felajanlokSzama > 0 ? 
                        Math.round(item.felajanlottOsszeg / item.felajanlokSzama) : 0;
                    
                    return [
                        item.sorszam,
                        `<span class="adoszam-display">${adoszam}</span>`,
                        item.nev,
                        item.szekhely,
                        item.felajanlottOsszeg.toLocaleString('hu-HU') + ' Ft',
                        item.felajanlokSzama + ' fő',
                        avgPerDonor.toLocaleString('hu-HU') + ' Ft'
                    ];
                });

                // DataTable inicializálása
                dataTable = $('#dataTable').DataTable({
                    data: tableData,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/hu.json'
                    },
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Összes"]],
                    order: [[4, 'desc']], // Felajánlott összeg szerint rendezés
                    columnDefs: [
                        {
                            targets: [4, 6], // Összeg oszlopok
                            className: 'text-end'
                        },
                        {
                            targets: [5], // Fő oszlop
                            className: 'text-center'
                        }
                    ],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"tr>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                });
            }

            // CSV export
            function exportToCSV() {
                if (!jsonData || !jsonData.adatok) {
                    showError('Nincs exportálható adat!');
                    return;
                }

                const csvContent = generateCSV(jsonData.adatok);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `felajanlasok_${moment().format('YYYY-MM-DD_HH-mm-ss')}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            // CSV generálás
            function generateCSV(adatok) {
                const headers = [
                    'Sorszám', 'Adószám', 'Cégnév', 'Székhely', 
                    'Felajánlott összeg (Ft)', 'Felajánlók száma (fő)', 'Átlagos felajánlás (Ft)'
                ];
                
                let csv = headers.join(';') + '\n';
                
                adatok.forEach(item => {
                    const adoszam = `${item.adoszam.resz1}-${item.adoszam.resz2}-${item.adoszam.resz3}`;
                    const avgPerDonor = item.felajanlokSzama > 0 ? 
                        Math.round(item.felajanlottOsszeg / item.felajanlokSzama) : 0;
                    
                    const row = [
                        item.sorszam,
                        adoszam,
                        `"${item.nev.replace(/"/g, '""')}"`,
                        `"${item.szekhely.replace(/"/g, '""')}"`,
                        item.felajanlottOsszeg,
                        item.felajanlokSzama,
                        avgPerDonor
                    ];
                    csv += row.join(';') + '\n';
                });
                
                return '\uFEFF' + csv; // UTF-8 BOM hozzáadása
            }

            // Hiba megjelenítése
            function showError(message) {
                $('#errorMessage').text(message);
                $('#errorModal').modal('show');
            }

            // Demo adat betöltése (teszteléshez)
            window.loadDemoData = function() {
                const demoData = {
                    "exportDatum": moment().format(),
                    "forrás": "2025 munkalap",
                    "rekordokSzáma": 3,
                    "adatok": [
                        {
                            "sorszam": "1",
                            "adoszam": {
                                "resz1": "12345678",
                                "resz2": "2",
                                "resz3": "01"
                            },
                            "nev": "ABC Kereskedelmi Kft.",
                            "szekhely": "1234 Budapest, Fő utca 12.",
                            "felajanlottOsszeg": 150000,
                            "felajanlokSzama": 5
                        },
                        {
                            "sorszam": "2",
                            "adoszam": {
                                "resz1": "98765432",
                                "resz2": "1",
                                "resz3": "09"
                            },
                            "nev": "XYZ Ipari Zrt.",
                            "szekhely": "4567 Debrecen, Nagy Lajos király útja 34.",
                            "felajanlottOsszeg": 250000,
                            "felajanlokSzama": 12
                        },
                        {
                            "sorszam": "3",
                            "adoszam": {
                                "resz1": "11223344",
                                "resz2": "5",
                                "resz3": "56"
                            },
                            "nev": "DEF Szolgáltató Bt.",
                            "szekhely": "7890 Szeged, Dugonics tér 1.",
                            "felajanlottOsszeg": 75000,
                            "felajanlokSzama": 3
                        }
                    ]
                };
                
                jsonData = demoData;
                processData(demoData);
            };

            // Demo gomb hozzáadása (fejlesztéshez)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const demoBtn = $('<button class="btn btn-outline-secondary ms-2">Demo adat</button>');
                demoBtn.on('click', loadDemoData);
                $('.d-flex.align-items-center').append(demoBtn);
            }
        });
    </script>
</body>
</html>